<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>database.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>database.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2021 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This source file contains an implementation of interface between Go code and
(almost any) SQL database like PostgreSQL, SQLite, or MariaDB.</p>

<p>It is possible to configure connection to selected database by using
StorageConfiguration structure. Currently that structure contains two
configurable parameter:</p>

<p>Driver - a SQL driver, like &quot;sqlite3&quot;, &quot;pq&quot; etc.
DataSource - specification of data source. The content of this parameter depends on the database used.</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Generated documentation is available at:
https://pkg.go.dev/github.com/RedHatInsights/insights-results-aggregator-cleaner</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bufio&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;math&#34;</div><div class="operator"></div>
	<div class="literal">&#34;os&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>

	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div>           <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>

	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriver type for db driver enum</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DBDriver</div> <div class="ident">int</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverSQLite3 shows that db driver is sqlite</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverSQLite3</div> <div class="ident">DBDriver</div> <div class="operator">=</div> <div class="ident">iota</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverPostgres shows that db driver is postgres</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverPostgres</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverGeneral general sql(used for mock now)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverGeneral</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">canNotConnectToDataStorageMessage</div> <div class="operator">=</div> <div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator"></div>
	<div class="ident">unableToCloseDBRowsHandle</div>         <div class="operator">=</div> <div class="literal">&#34;Unable to close the DB rows handle&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Other messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">tableName</div>      <div class="operator">=</div> <div class="literal">&#34;table&#34;</div><div class="operator"></div>
	<div class="ident">clusterNameMsg</div> <div class="operator">=</div> <div class="literal">&#34;cluster&#34;</div><div class="operator"></div>
	<div class="ident">fileOpenMsg</div>    <div class="operator">=</div> <div class="literal">&#34;File open&#34;</div><div class="operator"></div>
	<div class="ident">fileCloseMsg</div>   <div class="operator">=</div> <div class="literal">&#34;File close&#34;</div><div class="operator"></div>
	<div class="ident">flushWriterMsg</div> <div class="operator">=</div> <div class="literal">&#34;Flush writer&#34;</div><div class="operator"></div>
	<div class="ident">writeToFileMsg</div> <div class="operator">=</div> <div class="literal">&#34;Write to file&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initDatabaseConnection initializes driver, checks if it's supported and
initializes connection to the storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initDatabaseConnection</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">driverName</div> <div class="operator">:=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>
	<div class="ident">dataSource</div> <div class="operator">:=</div> <div class="literal">&#34;&#34;</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;driverName&#34;</div><div class="operator">,</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;DB connection configuration&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initialize connection into selected database using the right driver</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driverType := DBDriverSQLite3
driver = &amp;sqlite3.SQLiteDriver{}</p>
</td>
	<td class="code"><pre><code>		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">SQLiteDataSource</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driverType := DBDriverPostgres
driver = &amp;pq.Driver{}</p>
</td>
	<td class="code"><pre><code>		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;postgresql://%v:%v@%v:%v/%v?%v&#34;</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPassword</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGParams</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;driver %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">canNotConnectToDataStorageMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to initialize connection to the storage</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if establishing a connection was successful</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">canNotConnectToDataStorageMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">connection</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>displayMultipleRuleDisable function read and displays clusters where
multiple users have disabled some rules.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">displayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">output</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">fout</div> <div class="operator">*</div><div class="ident">os</div><div class="operator">.</div><div class="ident">File</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">writer</div> <div class="operator">*</div><div class="ident">bufio</div><div class="operator">.</div><div class="ident">Writer</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">output</div> <div class="operator">!=</div> <div class="literal">&#34;&#34;</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create output file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">fout</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Create</div><div class="operator">(</div><div class="ident">output</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">fileOpenMsg</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>an object used to write to file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">writer</div> <div class="operator">=</div> <div class="ident">bufio</div><div class="operator">.</div><div class="ident">NewWriter</div><div class="operator">(</div><div class="ident">fout</div><div class="operator">)</div><div class="operator"></div>

	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>output needs to be flushed at the end</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">writer</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">writer</div><div class="operator">.</div><div class="ident">Flush</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">flushWriterMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>file needs to be closed at the end</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">fout</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fout</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">fileCloseMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>first query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query1</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_rule_toggle
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>second query to be performed</p>
</td>
	<td class="code"><pre><code>	<div class="ident">query2</div> <div class="operator">:=</div> <div class="literal">`
                select cluster_id, rule_id, count(*) as cnt
                  from cluster_user_rule_disable_feedback
                 group by cluster_id, rule_id
                having count(*)&gt;1
                 order by cnt desc;
`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the first query and display results</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">performDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">query1</div><div class="operator">,</div>
		<div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>the first query+display function might throw some error</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform second query and display results</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">performDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">query2</div><div class="operator">,</div>
		<div class="literal">&#34;cluster_user_rule_disable_feedback&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>second query+display function might throw some error</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>performDisplayMultipleRuleDisable function displays cluster names and org
ids where multiple users disabled any rule</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">performDisplayMultipleRuleDisable</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div>
	<div class="ident">writer</div> <div class="operator">*</div><div class="ident">bufio</div><div class="operator">.</div><div class="ident">Writer</div><div class="operator">,</div> <div class="ident">query</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform given query to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>iterate over all records that has been found</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">clusterName</div> <div class="ident">string</div><div class="operator"></div>
			<div class="ident">ruleID</div>      <div class="ident">string</div><div class="operator"></div>
			<div class="ident">count</div>       <div class="ident">int</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read one report</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ruleID</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">count</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the result set in case of any error</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to read organization ID for given cluster name</p>
</td>
	<td class="code"><pre><code>		<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readOrgID</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;readOrgID&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>just print the report, including organization ID</p>
</td>
	<td class="code"><pre><code>		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;table&#34;</div><div class="operator">,</div> <div class="ident">tableName</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;org ID&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterNameMsg</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;rule ID&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;count&#34;</div><div class="operator">,</div> <div class="ident">count</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Multiple rule disable&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export to file (if enabled)</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">writer</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Fprintf</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="literal">&#34;%d,%s,%s,%d\n&#34;</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">count</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">writeToFileMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>readOrgID function tries to read organization ID for given cluster name</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">readOrgID</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">&#34;select org_id from report where cluster = $1&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the query</p>
</td>
	<td class="code"><pre><code>	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;query&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>and check the result (if any)</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">orgID</div> <div class="ident">int</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read one organization ID returned in query result</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>proper error logging will be performed elsewhere</p>
</td>
	<td class="code"><pre><code>			<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterNameMsg</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;scan&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the result set in case of any error</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>no result?</p>
</td>
	<td class="code"><pre><code>	<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterNameMsg</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;no org_id for cluster&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>displayAllOldRecords function read all old records, ie. records that are
older than the specified time duration. Those records are simply displayed.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">displayAllOldRecords</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">output</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">fout</div> <div class="operator">*</div><div class="ident">os</div><div class="operator">.</div><div class="ident">File</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">writer</div> <div class="operator">*</div><div class="ident">bufio</div><div class="operator">.</div><div class="ident">Writer</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">output</div> <div class="operator">!=</div> <div class="literal">&#34;&#34;</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create output file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">fout</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Create</div><div class="operator">(</div><div class="ident">output</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">fileOpenMsg</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>an object used to write to file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">writer</div> <div class="operator">=</div> <div class="ident">bufio</div><div class="operator">.</div><div class="ident">NewWriter</div><div class="operator">(</div><div class="ident">fout</div><div class="operator">)</div><div class="operator"></div>

	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>output needs to be flushed at the end</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">writer</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">writer</div><div class="operator">.</div><div class="ident">Flush</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">flushWriterMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>file needs to be closed at the end</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">fout</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fout</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">fileCloseMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">performListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">performListOfOldReports</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">maxAge</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">writer</div> <div class="operator">*</div><div class="ident">bufio</div><div class="operator">.</div><div class="ident">Writer</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">&#34;SELECT cluster, reported_at, last_checked_at FROM report WHERE reported_at &lt; NOW() - $1::INTERVAL ORDER BY reported_at&#34;</div><div class="operator"></div>
	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">query</div><div class="operator">,</div> <div class="ident">maxAge</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>used to compute a real record age</p>
</td>
	<td class="code"><pre><code>	<div class="ident">now</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>iterate over all old records</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="operator">(</div>
			<div class="ident">clusterName</div> <div class="ident">string</div><div class="operator"></div>
			<div class="ident">reported</div>    <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
			<div class="ident">lastChecked</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
		<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read one old record from the report table</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">clusterName</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">reported</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">lastChecked</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>close the result set in case of any error</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>compute the real record age</p>
</td>
	<td class="code"><pre><code>		<div class="ident">age</div> <div class="operator">:=</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">math</div><div class="operator">.</div><div class="ident">Ceil</div><div class="operator">(</div><div class="ident">now</div><div class="operator">.</div><div class="ident">Sub</div><div class="operator">(</div><div class="ident">reported</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Hours</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">/</div> <div class="literal">24</div><div class="operator">)</div><div class="operator">)</div> <div class="operator"></div><div class="comment">// in days</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare for the report</p>
</td>
	<td class="code"><pre><code>		<div class="ident">reportedF</div> <div class="operator">:=</div> <div class="ident">reported</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">lastCheckedF</div> <div class="operator">:=</div> <div class="ident">lastChecked</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>just print the report</p>
</td>
	<td class="code"><pre><code>		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterNameMsg</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;reported&#34;</div><div class="operator">,</div> <div class="ident">reportedF</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;lastChecked&#34;</div><div class="operator">,</div> <div class="ident">lastCheckedF</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;age&#34;</div><div class="operator">,</div> <div class="ident">age</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Old report&#34;</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">writer</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Fprintf</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="literal">&#34;%s,%s,%s,%d\n&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">reportedF</div><div class="operator">,</div> <div class="ident">lastCheckedF</div><div class="operator">,</div> <div class="ident">age</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">writeToFileMsg</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>deleteRecordFromTable function deletes selected records (identified by
cluster name) from database</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">deleteRecordFromTable</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">table</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">key</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>it is not possible to use parameter for table name or a key
disable &quot;G202 (CWE-89): SQL string concatenation (Confidence: HIGH, Severity: MEDIUM)&quot;</p>

<h1>nosec G202</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="literal">&#34;DELETE FROM &#34;</div> <div class="operator">&#43;</div> <div class="ident">table</div> <div class="operator">&#43;</div> <div class="literal">&#34; WHERE &#34;</div> <div class="operator">&#43;</div> <div class="ident">key</div> <div class="operator">&#43;</div> <div class="literal">&#34; = $1;&#34;</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>println(sqlStatement)</p>
</td>
	<td class="code"><pre><code>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the SQL statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read number of affected (deleted) rows</p>
</td>
	<td class="code"><pre><code>	<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">result</div><div class="operator">.</div><div class="ident">RowsAffected</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">affected</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>tablesAndKeys contains list of all tables together with keys used to select
records to be deleted</p>
</td>
	<td class="code"><pre><code><div class="keyword">var</div> <div class="ident">tablesAndKeys</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">...</div><div class="operator">]</div><div class="ident">TableAndKey</div><div class="operator">{</div>
	<div class="operator">{</div>
		<div class="ident">TableName</div><div class="operator">:</div> <div class="literal">&#34;cluster_rule_toggle&#34;</div><div class="operator">,</div>
		<div class="ident">KeyName</div><div class="operator">:</div>   <div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">{</div>
		<div class="ident">TableName</div><div class="operator">:</div> <div class="literal">&#34;cluster_rule_user_feedback&#34;</div><div class="operator">,</div>
		<div class="ident">KeyName</div><div class="operator">:</div>   <div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">{</div>
		<div class="ident">TableName</div><div class="operator">:</div> <div class="literal">&#34;cluster_user_rule_disable_feedback&#34;</div><div class="operator">,</div>
		<div class="ident">KeyName</div><div class="operator">:</div>   <div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">{</div>
		<div class="ident">TableName</div><div class="operator">:</div> <div class="literal">&#34;rule_hit&#34;</div><div class="operator">,</div>
		<div class="ident">KeyName</div><div class="operator">:</div>   <div class="literal">&#34;cluster_id&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>must be at the end due to constraints</p>
</td>
	<td class="code"><pre><code>	<div class="operator">{</div>
		<div class="ident">TableName</div><div class="operator">:</div> <div class="literal">&#34;report&#34;</div><div class="operator">,</div>
		<div class="ident">KeyName</div><div class="operator">:</div>   <div class="literal">&#34;cluster&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>performCleanupInDB function cleans up all data for selected cluster names</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">performCleanupInDB</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div>
	<div class="ident">clusterList</div> <div class="ident">ClusterList</div><div class="operator">)</div> <div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initialize counters</p>
</td>
	<td class="code"><pre><code>	<div class="ident">deletionsForTable</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="ident">int</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableAndKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tablesAndKeys</div> <div class="operator">{</div>
		<div class="ident">deletionsForTable</div><div class="operator">[</div><div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">]</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform cleanup for selected cluster names</p>
</td>
	<td class="code"><pre><code>	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Cleanup started&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterList</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableAndKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tablesAndKeys</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to delete record from selected table</p>
</td>
	<td class="code"><pre><code>			<div class="ident">affected</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">deleteRecordFromTable</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div>
				<div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">,</div>
				<div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">KeyName</div><div class="operator">,</div>
				<div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Str</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to delete record&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;Affected&#34;</div><div class="operator">,</div> <div class="ident">affected</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Str</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">,</div> <div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Str</div><div class="operator">(</div><div class="ident">clusterNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">clusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
					<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Delete record&#34;</div><div class="operator">)</div><div class="operator"></div>
				<div class="ident">deletionsForTable</div><div class="operator">[</div><div class="ident">tableAndKey</div><div class="operator">.</div><div class="ident">TableName</div><div class="operator">]</div> <div class="operator">&#43;=</div> <div class="ident">affected</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Cleanup finished&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">deletionsForTable</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fillInDatabaseByTestData function fill-in database by test data (not to be
used against production database)</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">fillInDatabaseByTestData</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Fill-in database started&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">lastError</div> <div class="ident">error</div> <div class="operator">=</div> <div class="ident">nil</div><div class="operator"></div>

	<div class="ident">clusterNames</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">...</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;00000000-0000-0000-0000-000000000000&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;11111111-1111-1111-1111-111111111111&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;5d5892d4-1f74-4ccf-91af-548dfc9767aa&#34;</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">sqlStatements</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">...</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at, kafka_offset) values(1, $1, &#39;&#39;, &#39;2021-01-01&#39;, &#39;2021-01-01&#39;, 10)&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;INSERT INTO cluster_rule_toggle (cluster_id, rule_id, user_id, disabled, disabled_at, enabled_at, updated_at) values($1, 1, 1, 0, &#39;2021-01-01&#39;, &#39;2021-01-01&#39;, &#39;2021-01-01&#39;)&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;INSERT INTO cluster_rule_user_feedback (cluster_id, rule_id, user_id, message, user_vote, added_at, updated_at) values($1, 1, 1, &#39;foobar&#39;, 1, &#39;2021-01-01&#39;, &#39;2021-01-01&#39;)&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;INSERT INTO cluster_user_rule_disable_feedback (cluster_id, user_id, rule_id, message, added_at, updated_at) values($1, 1, 1, &#39;foobar&#39;, &#39;2021-01-01&#39;, &#39;2021-01-01&#39;)&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;INSERT INTO rule_hit (org_id, cluster_id, rule_fqdn, error_key, template_data) values(1, $1, &#39;foo&#39;, &#39;bar&#39;, &#39;&#39;)&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterNames</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;cluster name&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;data for new cluster&#34;</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">sqlStatements</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;SQL statement&#34;</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;inserting&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform the SQL statement</p>
</td>
	<td class="code"><pre><code>			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>failure is usually ok - it might mean that
the record with given cluster name already
exists</p>
</td>
	<td class="code"><pre><code>				<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Insert error&#34;</div><div class="operator">)</div><div class="operator"></div>
				<div class="ident">lastError</div> <div class="operator">=</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Fill-in database finished&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">lastError</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
